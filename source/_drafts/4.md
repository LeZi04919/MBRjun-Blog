---
title: 更新 Umami 至 v2
date: 2023-04-20 20:11:58
updated: 2023-04-20 20:11:58
categories: 教程
tags:
- umami
- 统计脚本
thumbnailImage: https://cos.mbrjun.cn/IMGS/2023/04/16/6e80897b-0e1d-4c11-b003-24893cae9ba7.webp
---
简单写一下 Umami 大版本升级（v1 到 v2）的教程  

Umami v2 有很多破坏性更改，自己更新的时候遇到了一些坑，所以自己整理一下升级教程
<!-- more -->

> 这不是官方教程，官方教程（英文）可以在[这里](https://umami.is/docs/migrate-v1-v2)找到

---

**升级前请确认你正在运行最新版本的 v1(v1.4.0)，否则升级时会报错**  

另外，强烈建议在升级之前备份数据库，如果数据库 dump 文件大于 50 MB，数据库更新可能需要几分钟才能完成  

## 关闭旧版本
首先先把 Umami 就版本关掉，如果你 Umami 是 systemd 自启，就用：  

{% tabbed_codeblock %}
    <!-- tab sh -->
        systemctl stop umami
    <!-- endtab -->
{% endtabbed_codeblock %} 

## 升级数据库
在更新程序版本前要升级数据库，在 umami 目录输入下面的命令即可：  

{% tabbed_codeblock %}
    <!-- tab sh -->
        npx @umami/migrate-v1-v2@latest
    <!-- endtab -->
{% endtabbed_codeblock %}

如果你卡在了 ``reify:prisma: http fetch GET 200`` 这个步骤，并不用担心升级出现了问题，只是程序在下载文件而已  

（中国大陆下载升级 prisma 大概会消耗半个多小时时间，也可能会更久， prisma 下载文件的地址是写死的，这意味着你改了 npm 注册表（镜像）也没有一点用，但是你可以设置一个 ``HTTPS_PROXY`` 变量来让他走代理）  

升级好之后会问你要不要删除旧的数据表，输入 ``y`` 或者 ``n`` 就行  

## 更新前准备
先检查一下自己的 Umami 配置文件（``.env``）有没有设置自定义 JS 名称（``TRACKER_SCRIPT_NAME``）  

更新 v2.2.0 之后，你需要在这个脚本名后加个 ``.js`` 才能正常跑，如果你原来是这样：  

{% tabbed_codeblock %}
    <!-- tab env -->
        TRACKER_SCRIPT_NAME=delightful
    <!-- endtab -->
{% endtabbed_codeblock %}

那么就改成：

{% tabbed_codeblock %}
    <!-- tab env -->
        TRACKER_SCRIPT_NAME=delightful.js
    <!-- endtab -->
{% endtabbed_codeblock %}

## 更新 Umami
先 stash 掉目前的更改，然后更新 Git 存储库：

{% tabbed_codeblock %}
    <!-- tab sh -->
        git stash
        git pull --rebase
    <!-- endtab -->
{% endtabbed_codeblock %}

更新完成后